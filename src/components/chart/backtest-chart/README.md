# BacktestChart Observer æ•°æ®æµæ›´æ–°

## ä¿®æ”¹æ¦‚è¿°

å‚è€ƒ `kline-chart` ç»„ä»¶çš„æ•°æ®æ›´æ–°æ–¹å¼ï¼Œå°† `backtest-chart` ç»„ä»¶ä»å®šæ—¶å™¨æ›´æ–°æ•°æ®æ”¹ä¸ºä½¿ç”¨ observer æ•°æ®æµæ›´æ–°æ•°æ®ã€‚åŒæ—¶ç§»é™¤äº†æ¨¡æ‹Ÿæ•°æ®ç”Ÿæˆå’Œæ§åˆ¶é¢æ¿ï¼Œæ”¹ä¸ºä»åç«¯è·å–çœŸå®æ•°æ®ã€‚

## æœ€æ–°ä¿®å¤

### KlineLegend æ•°æ®æç¤ºé—®é¢˜ä¿®å¤

**é—®é¢˜**ï¼šé¼ æ ‡ç§»åŠ¨æ—¶ï¼Œæ•°æ®æç¤ºä¸æ›´æ–°

**åŸå› åˆ†æ**ï¼š
1. `useLegend.ts` ä¸­ä»åœ¨ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ® `generateOHLCData(100)` ä½œä¸ºé»˜è®¤å€¼
2. å½“é¼ æ ‡ç§»åŠ¨åˆ°æ²¡æœ‰æ•°æ®çš„åŒºåŸŸæ—¶ï¼Œä¼šè®¾ç½® `legendData` ä¸º `null`ï¼Œå¯¼è‡´æç¤ºæ¶ˆå¤±
3. ç¼ºå°‘è°ƒè¯•æ—¥å¿—ï¼Œéš¾ä»¥å®šä½é—®é¢˜

**ä¿®å¤å†…å®¹**ï¼š
1. ç§»é™¤æ¨¡æ‹Ÿæ•°æ®ä¾èµ–ï¼Œä½¿ç”¨ç©ºæ•°ç»„ä½œä¸ºé»˜è®¤å€¼
2. ä¿®æ”¹ `onCrosshairMove` é€»è¾‘ï¼Œå½“æ²¡æœ‰æ•°æ®æ—¶æ˜¾ç¤ºæœ€åä¸€ä¸ªæ•°æ®ç‚¹è€Œä¸æ˜¯ `null`
3. **æ ¸å¿ƒä¿®å¤**ï¼šä¿®æ”¹ `LegendData` æ—¶é—´ç»“æ„ï¼Œè§£å†³åˆ†é’Ÿçº§æ•°æ®æ›´æ–°é—®é¢˜
   - å°† `time: string` æ”¹ä¸º `time: Time`ï¼Œä¸ Kçº¿æ•°æ®ä¿æŒä¸€è‡´
   - æ–°å¢ `timeString: string` å­—æ®µç”¨äºæ˜¾ç¤ºæ ¼å¼åŒ–çš„æ—¶é—´
   - æ›´æ–°æ—¶é—´æ ¼å¼ä¸º `YYYY-MM-DD HH:mm`ï¼Œæ”¯æŒåˆ†é’Ÿçº§æ˜¾ç¤º
4. æ·»åŠ è¯¦ç»†çš„è°ƒè¯•æ—¥å¿—ï¼Œä¾¿äºé—®é¢˜æ’æŸ¥
5. æ¸…ç†æœªä½¿ç”¨çš„å¯¼å…¥å’Œå¯¼å‡º
6. åœ¨ Legend ç»„ä»¶ä¸­æ˜¾ç¤ºæ—¶é—´ä¿¡æ¯

## ä¸»è¦ä¿®æ”¹

### 1. realTimeStore.ts ä¿®æ”¹

- **æ–°å¢æ¥å£å­—æ®µ**ï¼š
  - `chartRef: IChartApi | null` - Chart API å¼•ç”¨
  - `subscriptions: Subscription[]` - RxJS è®¢é˜…åˆ—è¡¨
  - `klineKeyStr: string` - Kçº¿ç¼“å­˜é”®
  - `enabled: boolean` - æ˜¯å¦å¯ç”¨ Observer æ•°æ®æµ

- **æ–°å¢æ–¹æ³•**ï¼š
  - `setChartRef(chart: IChartApi)` - è®¾ç½® Chart å¼•ç”¨
  - `setKlineKeyStr(keyStr: string)` - è®¾ç½® Kçº¿ç¼“å­˜é”®
  - `setEnabled(enabled: boolean)` - è®¾ç½®æ˜¯å¦å¯ç”¨
  - `initObserverSubscriptions()` - åˆå§‹åŒ– Observer è®¢é˜…
  - `cleanupSubscriptions()` - æ¸…ç†è®¢é˜…
  - `onNewKline(kline: Kline)` - å¤„ç†æ–°Kçº¿æ•°æ®

- **Observer è®¢é˜…é€»è¾‘**ï¼š
  - ä½¿ç”¨ `createKlineStreamFromKey` åˆ›å»º Kçº¿æ•°æ®æµ
  - è®¢é˜…æ•°æ®æµå¹¶åœ¨æ”¶åˆ°æ–°æ•°æ®æ—¶è°ƒç”¨ `onNewKline` æ–¹æ³•
  - å°† Kline æ•°æ®è½¬æ¢ä¸º FlexibleCandlestickData æ ¼å¼
  - ä½¿ç”¨ç°æœ‰çš„ `updateSinglePoint` æ–¹æ³•æ›´æ–°å›¾è¡¨

### 2. index.tsx ä¿®æ”¹

- **æ–°å¢ Props æ¥å£**ï¼š
  ```typescript
  interface BacktestChartProps {
    klineKeyStr?: string; // Kçº¿ç¼“å­˜é”®
    enabled?: boolean; // æ˜¯å¦å¯ç”¨Observeræ•°æ®æµ
  }
  ```

- **Chart onInit å›è°ƒ**ï¼š
  - ä½¿ç”¨ Chart ç»„ä»¶çš„ `onInit` æ–¹æ³•è·å– Chart API å¼•ç”¨
  - åœ¨ Chart åˆå§‹åŒ–å®Œæˆåè‡ªåŠ¨åˆå§‹åŒ– Observer è®¢é˜…

- **ç”Ÿå‘½å‘¨æœŸç®¡ç†**ï¼š
  - ç»„ä»¶æŒ‚è½½æ—¶è®¾ç½®é…ç½®å‚æ•°
  - ç»„ä»¶å¸è½½æ—¶æ¸…ç† Observer è®¢é˜…å’Œå®šæ—¶å™¨

## ä½¿ç”¨æ–¹å¼

### æ–°çš„ Props æ¥å£

```tsx
interface BacktestChartProps {
  strategyId: number;
  chartConfig: BacktestChartConfig;
}
```

### ä½¿ç”¨ç¤ºä¾‹

```tsx
// åˆ›å»º KlineChartConfig
const klineChartConfig: KlineChartConfig = {
  klineKeyStr: "binance:BTCUSDT:1m",
  upColor: "#22c55e",
  downColor: "#ef4444",
  indicatorChartConfig: {},
};

// åˆ›å»º BacktestChartConfig
const chartConfig: BacktestChartConfig = {
  id: 1,
  chartName: "BTC/USDT 1åˆ†é’Ÿ",
  klineChartConfig: klineChartConfig,
  subChartConfigs: [],
};

// ä½¿ç”¨ç»„ä»¶
<BacktestChart
  strategyId={1}
  chartConfig={chartConfig}
/>
```

### è‡ªåŠ¨å¯ç”¨ Observer æ•°æ®æµ

ç»„ä»¶ä¼šè‡ªåŠ¨ä» `chartConfig.klineChartConfig.klineKeyStr` è·å– Kçº¿ç¼“å­˜é”®ï¼Œå¹¶é»˜è®¤å¯ç”¨ Observer æ•°æ®æµæ›´æ–°ã€‚

### æ—¶é—´æˆ³æ ¼å¼å¤„ç†

- **åç«¯æ•°æ®**ï¼šæ¯«ç§’çº§æ—¶é—´æˆ³ (timestamp: number)
- **å›¾è¡¨æ ¼å¼**ï¼šç§’çº§ UTCTimestamp æ ¼å¼
- **è½¬æ¢é€»è¾‘**ï¼š`Math.floor(kline.timestamp / 1000) as UTCTimestamp`

è¿™ç¬¦åˆ lightweight-charts å®˜æ–¹æ–‡æ¡£çš„è¦æ±‚ï¼Œæ”¯æŒä»¥ä¸‹æ—¶é—´æ ¼å¼ï¼š
- `UTCTimestamp` (æ•°å­—ï¼Œç§’çº§æ—¶é—´æˆ³)
- `BusinessDay` (å¯¹è±¡ï¼Œå¦‚ `{year: 2019, month: 6, day: 1}`)
- `string` (å­—ç¬¦ä¸²ï¼Œå¦‚ `'2021-02-03'`)

### Legend æ•°æ®ç»“æ„ä¼˜åŒ–

**é—®é¢˜æ ¹å› **ï¼šåŸå§‹çš„ `LegendData` ä½¿ç”¨æ—¥æœŸå­—ç¬¦ä¸²è¿›è¡Œæ—¶é—´æ¯”è¾ƒï¼Œå¯¼è‡´åŒä¸€å¤©çš„ä¸åŒåˆ†é’Ÿ Kçº¿è¢«è®¤ä¸ºæ˜¯ç›¸åŒæ•°æ®ã€‚

```typescript
// ä¿®æ”¹å‰ - é—®é¢˜ç»“æ„
export type LegendData = {
  time: string; // "2024-01-01" - åªæœ‰æ—¥æœŸï¼Œåˆ†é’Ÿçº§æ•°æ®ä¼šé‡å¤
  // ...å…¶ä»–å­—æ®µ
};

// ä¿®æ”¹å - æ­£ç¡®ç»“æ„
export type LegendData = {
  time: Time; // 1704067200 - ç²¾ç¡®çš„æ—¶é—´æˆ³ï¼Œæ”¯æŒåˆ†é’Ÿçº§æ¯”è¾ƒ
  timeString: string; // "2024-01-01 10:30" - ç”¨äºæ˜¾ç¤ºçš„æ ¼å¼åŒ–æ—¶é—´
  // ...å…¶ä»–å­—æ®µ
};
```

**ä¿®å¤æ•ˆæœ**ï¼š
- âœ… æ¯ä¸ªåˆ†é’Ÿçš„ Kçº¿éƒ½æœ‰å”¯ä¸€çš„æ—¶é—´æ ‡è¯†
- âœ… Legend èƒ½æ­£ç¡®å“åº”é¼ æ ‡ç§»åŠ¨åˆ°ä¸åŒåˆ†é’Ÿçš„ Kçº¿
- âœ… æ—¶é—´æ˜¾ç¤ºæ›´ç²¾ç¡®ï¼ŒåŒ…å«å°æ—¶å’Œåˆ†é’Ÿä¿¡æ¯

### Crosshair æ—¶é—´æ ¼å¼åŒ–

**æ–°å¢åŠŸèƒ½**ï¼šè‡ªå®šä¹‰ Crosshair æ—¶é—´çº¿ä¸Šçš„æ—¶é—´æ˜¾ç¤ºæ ¼å¼

```typescript
// åœ¨å›¾è¡¨åˆå§‹åŒ–æ—¶è®¾ç½®è‡ªå®šä¹‰æ—¶é—´æ ¼å¼åŒ–å™¨
chart.applyOptions({
  localization: {
    timeFormatter: (time: Time) => {
      if (typeof time === "number") {
        return dayjs(time * 1000).format("YYYY-MM-DD HH:mm");
      }
      // å¤„ç†å…¶ä»–æ—¶é—´æ ¼å¼...
    },
  },
});
```

**æ•ˆæœ**ï¼š
- âœ… Crosshair æ—¶é—´çº¿æ˜¾ç¤ºæ ¼å¼ï¼š`2024-01-01 10:30`
- âœ… ä¸ Legend æ—¶é—´æ ¼å¼ä¿æŒä¸€è‡´
- âœ… æ”¯æŒåˆ†é’Ÿçº§ç²¾åº¦æ˜¾ç¤º

### æ—¶é—´è½´åˆ»åº¦æ™ºèƒ½ä¼˜åŒ–

**æ–°å¢åŠŸèƒ½**ï¼šä½¿ç”¨ `tickMarkFormatter` å®ç°æ ¹æ®å›¾è¡¨ç¼©æ”¾çº§åˆ«åŠ¨æ€è°ƒæ•´æ—¶é—´åˆ»åº¦æ˜¾ç¤º

```typescript
timeScale: {
  tickMarkFormatter: (time: Time, tickMarkType: TickMarkType, locale: string) => {
    const date = dayjs(time * 1000);

    switch (tickMarkType) {
      case 0: // Year - å›¾è¡¨ç¼©å°åˆ°å¹´çº§åˆ«
        return date.format("YYYY");
      case 1: // Month - å›¾è¡¨ç¼©å°åˆ°æœˆçº§åˆ«
        return date.format("MMæœˆ");
      case 2: // DayOfMonth - å›¾è¡¨ç¼©å°åˆ°æ—¥çº§åˆ«
        return `${date.format("DD")}æ—¥`;
      case 3: // Time - å›¾è¡¨æ”¾å¤§åˆ°å°æ—¶/åˆ†é’Ÿçº§åˆ«
        return date.format("HH:mm");
      case 4: // TimeWithSeconds - å›¾è¡¨æ”¾å¤§åˆ°ç§’çº§åˆ«
        return date.format("HH:mm:ss");
    }
  },
}
```

**æ™ºèƒ½æ˜¾ç¤ºé€»è¾‘**ï¼š
- ğŸ“… **å›¾è¡¨ç¼©å°æ—¶**ï¼šæ˜¾ç¤ºæ›´å¤§çš„æ—¶é—´å•ä½
  - å¹´çº§åˆ«ï¼š`2024`
  - æœˆçº§åˆ«ï¼š`01æœˆ`
  - æ—¥çº§åˆ«ï¼š`15æ—¥`
- â° **å›¾è¡¨æ”¾å¤§æ—¶**ï¼šæ˜¾ç¤ºæ›´ç²¾ç¡®çš„æ—¶é—´å•ä½
  - å°æ—¶/åˆ†é’Ÿçº§åˆ«ï¼š`10:30`
  - ç§’çº§åˆ«ï¼š`10:30:45`
- ğŸ¯ **é»˜è®¤æƒ…å†µ**ï¼šæ™ºèƒ½åˆ¤æ–­æ˜¾ç¤ºæ—¥æœŸæˆ–æ—¶é—´

**ç”¨æˆ·ä½“éªŒ**ï¼š
- âœ… å›¾è¡¨ç¼©æ”¾æ—¶æ—¶é—´è½´è‡ªåŠ¨é€‚åº”æ˜¾ç¤ºå¯†åº¦
- âœ… é¿å…æ—¶é—´æ ‡ç­¾é‡å å’Œæ‹¥æŒ¤
- âœ… æä¾›æœ€ç›¸å…³çš„æ—¶é—´ä¿¡æ¯
- âœ… ä¸­æ–‡å‹å¥½çš„æ—¶é—´æ ¼å¼

## æ•°æ®æµç¨‹

1. **åˆå§‹åŒ–é˜¶æ®µ**ï¼š
   - Chart ç»„ä»¶åˆå§‹åŒ–å®Œæˆï¼Œè§¦å‘ `onInit` å›è°ƒ
   - è®¾ç½® Chart API å¼•ç”¨åˆ° store
   - è°ƒç”¨ `initObserverSubscriptions()` åˆå§‹åŒ–è®¢é˜…

2. **æ•°æ®åˆå§‹åŒ–é˜¶æ®µ**ï¼š
   - è°ƒç”¨ `initKlineData()` ä»åç«¯è·å–åˆå§‹Kçº¿æ•°æ®
   - æ•°æ®æŒ‰æ—¶é—´æˆ³æ’åºç¡®ä¿æ­£ç¡®é¡ºåº
   - è½¬æ¢ä¸º lightweight-charts æ ¼å¼å¹¶è®¾ç½®åˆ°å›¾è¡¨

3. **æ•°æ®æ›´æ–°é˜¶æ®µ**ï¼š
   - Observer æ¥æ”¶åˆ°æ–°çš„ Kçº¿æ•°æ®
   - è°ƒç”¨ `onNewKline()` å¤„ç†æ•°æ®
   - å°† Kline æ•°æ®è½¬æ¢ä¸ºå›¾è¡¨æ ¼å¼
   - ä½¿ç”¨ `series.update()` æ–¹æ³•æ›´æ–°å›¾è¡¨

3. **æ¸…ç†é˜¶æ®µ**ï¼š
   - ç»„ä»¶å¸è½½æ—¶è°ƒç”¨ `cleanupSubscriptions()`
   - å–æ¶ˆæ‰€æœ‰ RxJS è®¢é˜…
   - æ¸…ç†å®šæ—¶å™¨èµ„æº

## å…¼å®¹æ€§

- ä¿ç•™äº†åŸæœ‰çš„å®šæ—¶å™¨æ›´æ–°é€»è¾‘ï¼Œç¡®ä¿å‘åå…¼å®¹
- å¯ä»¥é€šè¿‡ `enabled` å‚æ•°æ§åˆ¶ä½¿ç”¨å“ªç§æ›´æ–°æ–¹å¼
- UI é€»è¾‘ä¿æŒä¸å˜ï¼Œåªä¿®æ”¹äº†æ•°æ®æ›´æ–°æœºåˆ¶

## æ§åˆ¶ç•Œé¢æ›´æ–°

### RealTimeControls.tsx æ–°å¢åŠŸèƒ½

- **Observer æ•°æ®æµå¼€å…³**ï¼šæ§åˆ¶æ˜¯å¦å¯ç”¨ Observer æ¨¡å¼
- **Kçº¿ç¼“å­˜é”®è¾“å…¥**ï¼šåœ¨ Observer æ¨¡å¼ä¸‹è®¾ç½®è¦ç›‘å¬çš„æ•°æ®æº
- **æ™ºèƒ½çŠ¶æ€æ˜¾ç¤º**ï¼šæ ¹æ®å½“å‰æ¨¡å¼æ˜¾ç¤ºä¸åŒçš„çŠ¶æ€ä¿¡æ¯

### æ§åˆ¶é€»è¾‘

- å¯ç”¨ Observer æ—¶è‡ªåŠ¨åœæ­¢å®šæ—¶å™¨å¹¶åˆå§‹åŒ–è®¢é˜…
- ç¦ç”¨ Observer æ—¶æ¸…ç†è®¢é˜…ï¼Œå¯æ‰‹åŠ¨å¯åŠ¨å®šæ—¶å™¨
- å®æ—¶æ˜¾ç¤ºå½“å‰ç›‘å¬çš„æ•°æ®æº

## æµ‹è¯•

ä½¿ç”¨ `test-observer.tsx` æ–‡ä»¶å¯ä»¥æµ‹è¯•ä¸¤ç§æ›´æ–°æ¨¡å¼ï¼š
- Observer æ•°æ®æµæ›´æ–°
- å®šæ—¶å™¨æ›´æ–°ï¼ˆå…¼å®¹æ¨¡å¼ï¼‰

## æ–‡ä»¶ä¿®æ”¹æ¸…å•

1. **klinechart-store.ts** - æ ¸å¿ƒæ•°æ®ç®¡ç†
   - æ–°å¢ Observer ç›¸å…³çŠ¶æ€å’Œæ–¹æ³•
   - å®ç° Kçº¿æ•°æ®æµè®¢é˜…é€»è¾‘
   - æ•°æ®æ ¼å¼è½¬æ¢ï¼šæ¯«ç§’çº§æ—¶é—´æˆ³è½¬æ¢ä¸ºç§’çº§ UTCTimestamp
   - å›¾è¡¨æ›´æ–°é€»è¾‘

2. **index.tsx** - ç»„ä»¶ä¸»æ–‡ä»¶
   - æ›´æ–° Props æ¥å£ï¼Œæ¥æ”¶ strategyId å’Œ chartConfig
   - ä» chartConfig.klineChartConfig.klineKeyStr è·å– Kçº¿ç¼“å­˜é”®
   - å®ç° Chart onInit å›è°ƒ
   - ç”Ÿå‘½å‘¨æœŸç®¡ç†å’Œèµ„æºæ¸…ç†
   - é»˜è®¤å¯ç”¨ Observer æ•°æ®æµ

3. **RealTimeControls.tsx** - æ§åˆ¶ç•Œé¢
   - æ–°å¢ Observer æ¨¡å¼æ§åˆ¶å¼€å…³
   - Kçº¿ç¼“å­˜é”®è¾“å…¥æ¡†
   - æ™ºèƒ½çŠ¶æ€æ˜¾ç¤º

4. **mock-data.ts** - æ•°æ®ç±»å‹å’Œç”Ÿæˆ
   - æ›´æ–° FlexibleCandlestickData ç±»å‹ä½¿ç”¨ lightweight-charts çš„ Time ç±»å‹
   - ä¿®æ”¹ generateOHLCData ç”Ÿæˆç§’çº§æ—¶é—´æˆ³
   - æ›´æ–° generateNextDataPoint å¤„ç†æ•°å­—æ—¶é—´æˆ³

5. **test-observer.tsx** - æµ‹è¯•æ–‡ä»¶
   - æ›´æ–°æµ‹è¯•ç”¨ä¾‹ä½¿ç”¨æ–°çš„ Props æ ¼å¼

6. **README.md** - æ–‡æ¡£è¯´æ˜
   - è¯¦ç»†çš„ä¿®æ”¹è¯´æ˜å’Œä½¿ç”¨æŒ‡å—
   - æ—¶é—´æˆ³æ ¼å¼å¤„ç†è¯´æ˜
